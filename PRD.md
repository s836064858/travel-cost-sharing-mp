# 多人旅游账单分摊 — 产品需求文档（MVP）

## 一、产品目标

- 在多人旅行中快速记录账单并按参与者分摊，减少手工统计与沟通成本。
- 每笔账单可仅在部分人之间分摊，灵活适应真实场景。
- 旅行结束自动生成结算建议，清晰呈现“谁需要给谁多少钱”，尽量减少转账笔数。

## 二、目标用户

- 朋友、同事、家庭等 2–20 人的出行团队。
- 多人共同消费、经常由不同成员代付的旅行或活动组织者。
- 希望对账透明、轻量记录的普通用户。

## 三、核心使用场景

- 出发前：创建旅行，设置参与人数与成员信息。
- 路途中：随手记账（A 代付餐费、B 代付门票、C 代付住宿等），并为每笔账单选择参与分摊成员。
- 结束时：一键结算，生成最少转账方案，展示“张三 → 李四 120 元”等建议；支持导出分享。

## 四、功能范围（MVP）

### 4.1 旅行与参与者管理

- 创建旅行：名称、开始日期、主币种、成员列表（昵称与可选头像）。
- 成员增删：已有账单后不建议删除，可“停用”但保留历史；新增成员不影响历史账单，默认参与后续账单。

### 4.2 记账与分摊

- 新增账单：金额、付款人、名称、类别（餐饮/交通/住宿/门票/其他）、日期、备注。
- 分摊范围：选择参与分摊的成员（非必须全员），默认均分；支持自定义比例/权重或固定金额。
- 币种：仅支持单一币种；不考虑多币种与汇率。

### 4.3 可视化与统计

- 旅行总览：总支出、按人/类别汇总、个人净额（应收/应付）。
- 账单列表与筛选：按日期、类别、付款人、参与者过滤。

### 4.4 结算

- 自动生成结算建议：展示“谁需要给谁多少钱”，尽量减少转账笔数。
- 结算标记：选择结算方式（现金、微信/支付宝、银行转账等），记录已结算状态与时间。

### 4.5 分享与导出

- 导出总览与结算方案（图片/PDF/CSV），支持分享链接。

### 4.6 基础设置

- 类别管理（餐饮/交通/住宿/门票/其他）、日期范围、备注输入。
- 代理人设置（可选）：支持为夫妻/情侣等关系选择一人作为结算代理人。

## 五、非 MVP 的可选功能（迭代）

- 角色与权限（编辑者/只读）、多人协作实时同步与变更历史。
 - 结算进度跟踪。
- 离线记录与自动同步。
- 预算与偏差提醒。

## 六、用户流程

### 6.1 创建旅行

- 输入旅行名称、开始日期、主币种（MVP 单一币种）。
- 添加成员昵称与头像（可选）。
 - 设置代理人（可选）：为夫妻/情侣选择一名成员作为结算代理人。

### 6.2 记账

- 选择付款人，输入金额、类别、日期、备注。
- 选择参与分摊成员（默认全员，可调整）。
- 选择分摊方式：
  - 均分：参与者平均分摊。
  - 自定义比例：各参与者填分摊比例或固定金额（总和=账单金额）。

### 6.3 查看统计

- 每人净额：正数为应收（别人需付给他），负数为应付（他需付给别人）。
- 按类别汇总，账单列表与筛选。

### 6.4 结算

- 自动计算结算建议，生成若干“转账对”的建议，减少笔数与循环支付。
- 标记已结算：记录方式与时间；导出分享给成员。

## 七、结算逻辑

### 7.1 概念定义

- 实付：某成员为账单付款的总额。
- 应付：参与分摊成员应承担的份额。
- 个人净额：`net[i] = 支付总额[i] - 应付总额[i]`。
  - `net[i] > 0`：该成员垫付多，别人需付给他。
  - `net[i] < 0`：该成员受益多，他需付给别人。

### 7.2 结算目标

- 使所有人的净额归零，生成有向转账建议。
- 优先减少转账笔数，避免循环支付。

### 7.3 推荐算法（最小现金流近似贪心）

1. 将成员分为「债权人」（`net>0`）与「债务人」（`net<0`）。
2. 选出净额绝对值最大的债权人与债务人匹配，转账金额为两者绝对值较小者。
3. 更新两者净额，净额归零者出队，重复直至所有净额为零。

### 7.4 示例

- 成员：A、B、C。
- 账单 1：A 代付 300，参与 A/B/C 均分，各应付 100。
- 账单 2：B 代付 120，仅 B/C 参与，均分各 60。
- 净额：
  - A：支付 300，应付 100 → `net=+200`
  - B：支付 120，应付 160 → `net=-40`
  - C：支付 0，应付 160 → `net=-160`
- 结算建议：
  - C → A 160
  - B → A 40
- 结果：A 收 200；B、C 分别付清，所有 `net` 归零。

### 7.5 代理人（结算代理）

- 需求：夫妻/情侣可以选择一人为代理人，结算时由代理人统一收/付，减少转账笔数并简化沟通。
- 行为范围（MVP）：仅影响“结算建议”阶段，不改变账单分摊与个人净额的统计展示。
- 算法融入：
  1) 正常计算每个人的 `net`；
  2) 将设为代理的成员及其被代理成员的 `net` 聚合到代理人：`net_agent = Σ(net_agent 和所有 delegates)`；
  3) 生成结算建议时，使用聚合后的代理人节点参与匹配；被代理成员在结算建议中不直接出现；
  4) 展示上支持「折叠/展开」：折叠显示代理人的聚合结算，展开可查看各成员个人净额明细（但不产生独立转账）。
- 边界：
  - 仅支持一级代理，禁止形成链式代理（A 代理 B，B 再代理 C）。
  - 一个成员只能属于一个代理关系，不可重复被不同代理人代理。
  - 可随时启用/停用代理设置；停用后重新计算结算建议。
  - 导出与分享时应标注代理关系，避免误解。
- 例子：
  - 成员：A、B（情侣，A 为代理人）、C。
  - `net`：A +200，B -50，C -150。
  - 代理聚合：A 的聚合净额 = 200 + (-50) = +150；B 在结算建议中折叠。
  - 结算建议：C → A 150；最终只需一笔转账，A 收 150。

## 八、分摊规则

- 均分：按参与者人数平均分摊，支持四舍五入设置（到分/到厘）。
- 自定义比例：支持比例或固定金额输入，合计必须等于账单总额。
- 手动调整：快速编辑各人应付份额，保障灵活性。

## 九、数据模型（MVP）

- `Trip`：`id`、`name`、`currency`、`start_date`、`end_date`、`members[]`。
- `Member`：`id`、`display_name`、`avatar_url?`、`role`。
- `Bill`：`id`、`trip_id`、`payer_id`、`amount`、`currency`、`category`、`date`、`note?`。
- `BillShare`：`bill_id`、`member_id`、`share_amount` 或 `share_ratio`。
- `Settlement`（计算产物）：`trip_id`、`from_member_id`、`to_member_id`、`amount`、`status`（`suggested|paid`）、`method?`、`paid_at?`。
- 统计缓存（可选）：按人、按类别聚合结果加速呈现。
 - `SettlementAgent`（结算代理设置）：`id`、`trip_id`、`agent_member_id`、`delegate_member_ids[]`、`active`、`note?`。

## 十、权限与协作

- MVP：所有成员均可编辑或由单管理员维护（简化）。
- 迭代：邀请机制、成员权限（编辑/只读）、变更历史、锁定已结算账单。

## 十一、边界与规则

- 成员变动：已有账单后不建议删除，可停用保留历史；新增成员不影响历史。
- 金额精度与舍入：金额到分（0.01），分摊时保留到分，差额由最后一人或随机分配补齐。
- 账单编辑与作废：支持编辑与删除，自动更新统计与结算建议。
- 旅行关闭：结束后可关闭，仅查看与导出；如需补记可重新开启。
- 安全与隐私：本地数据加密（迭代），分享链接有效期或访问码。
 - 代理人规则：仅影响结算阶段，禁止代理链与多重归属；代理生效后在结算建议中折叠展示并在导出中标注。

## 十二、报表与导出

- 旅行总览：总额、笔数、按类别与按人汇总。
- 个人报表：每人成本明细与净额。
- 结算清单：转账建议列表。
- 导出：`CSV`（账单/分摊）、`PDF/图片`（结算建议）、分享链接。

## 十三、成功指标（MVP）

- 创建旅行与记账完成率。
- 人均记账时长（越短越好）。
- 结算一次生成能覆盖 ≥95% 场景，用户编辑少于 1 次。
- 导出与分享使用率。

## 十四、MVP 范围与优先级

- 必做：
  - 单币种旅行、成员管理、记账（部分人分摊）、均分与自定义比例。
  - 统计总览、净额计算、自动结算建议、“谁给谁多少钱”视图。
  - 导出分享（基础图片或 PDF）。
- 次优：类别管理、账单筛选、备注。
- 延后：协作权限、离线能力。

## 十五、技术简述（可选方向）

- 客户端：Web（React/Vue）、移动端（Flutter/React Native）。
- 存储：本地优先（IndexedDB/SQLite），或云端（Supabase/Firebase）。
- 结算：前端计算即可；多人协作时可下沉到后端服务。

## 十六、下一步建议

- 明确端形态（Web 或移动），确定 MVP 技术栈与数据存储。
- 基于本 PRD 搭建项目骨架（页面：旅行总览、记账表单、结算视图）。
- 实现并验证结算算法与示例数据；完善导出分享能力。
