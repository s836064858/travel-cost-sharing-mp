<!-- pages/trip-detail/trip-detail.wxml -->
<view class="page-container">
  <!-- é¡¶éƒ¨èƒŒæ™¯ï¼Œä¸é¦–é¡µä¸€è‡´ -->
  <view class="top-bg"></view>

  <!-- å†…å®¹åŒºåŸŸåŒ…è£¹ï¼Œä¸é¦–é¡µä¸€è‡´ -->
  <view class="content-wrapper">
    <!-- æ—…è¡ŒåŸºæœ¬ä¿¡æ¯ -->
    <view class="card card-shadow trip-info">
      <view class="trip-header">
        <text class="trip-name">{{ trip.name }}</text>
        <text class="trip-status {{ trip.status }}">{{ trip.status === 'created' ? 'æœªå¼€å§‹' : trip.status === 'ongoing' ? 'è¿›è¡Œä¸­' : 'å·²ç»“æŸ' }} </text>
      </view>
    </view>
    <!-- åŠŸèƒ½å…¥å£ -->
    <view class="card card-shadow actions-section" wx:if="{{ trip.status === 'ongoing' }}">
      <view class="action-grid">
        <view class="action-item" bindtap="addBill">
          <text class="action-icon">ğŸ’°</text>
          <text class="action-text">å¢åŠ è´¦å•</text>
        </view>
        <view class="action-item" bindtap="addMember">
          <text class="action-icon">â•</text>
          <text class="action-text">æ–°å¢æˆå‘˜</text>
        </view>
        <view class="action-item" bindtap="endTrip">
          <text class="action-icon">ğŸ</text>
          <text class="action-text">ç»“æŸæ—…è¡Œ</text>
        </view>
      </view>
    </view>
    <!-- æˆå‘˜åˆ—è¡¨ -->
    <view class="card card-shadow members-section">
      <view class="section-header">
        <text class="section-title">æˆå‘˜åˆ—è¡¨ {{ activeMembers.length }}äºº</text>
      </view>
      <view class="members-list">
        <view wx:for="{{ activeMembers }}" wx:key="id" class="member-item">
          <view class="member-avatar">
            <image wx:if="{{ item.avatarUrl }}" src="{{ item.avatarUrl }}" mode="aspectFill" />
            <view wx:else class="text-avatar">{{ item.initials }}</view>
          </view>
          <view class="member-info">
            <text class="member-name">{{ item.name }}</text>
            <view class="member-agent" style="display: flex; align-items: center" wx:if="{{ item.agent }}">
              <text style="font-size: 24rpx; color: #666">ä»£ç†ï¼š</text>
              <view class="member-avatar" style="width: 56rpx; height: 56rpx; border: 2rpx solid #07c160">
                <image wx:if="{{ item.agent.avatarUrl }}" src="{{ item.agent.avatarUrl }}" mode="aspectFill" />
                <view wx:else class="text-avatar">{{ item.agent.initials }}</view>
              </view>
            </view>
          </view>
          <view class="btn-secondary" bindtap="setMemberAgent" data-member-id="{{ item.id }}" wx:if="{{ trip.status !== 'closed' }}">è®¾ä»£ç†</view>
        </view>
      </view>
    </view>
    <!-- æœ€è¿‘è´¦å• -->
    <view class="card card-shadow bills-section" wx:if="{{ trip.status === 'ongoing' }}">
      <view class="section-header">
        <text class="section-title">æœ€è¿‘è´¦å•</text>
      </view>
      <view class="bills-list">
        <view wx:for="{{ recentBills }}" wx:key="_id" class="bill-item" bindtap="editBill" data-bill="{{ item }}">
          <view class="bill-header">
            <view class="bill-category {{ item.category }}">{{ item.categoryText }}</view>
            <text class="bill-amount">Â¥{{ item.amount }}</text>
          </view>
          <view class="bill-info">
            <view class="bill-participants">
              <text class="bill-participants-label">æ”¯ä»˜ä¸å‚ä¸</text>
              <view class="avatars-list stacked">
                <view
                  wx:for="{{ item.displayParticipants }}"
                  wx:for-item="p"
                  wx:for-index="idx"
                  wx:key="id"
                  class="avatar-small {{ idx === 0 ? 'payer' : '' }}"
                >
                  <image wx:if="{{ p.avatarUrl }}" src="{{ p.avatarUrl }}" mode="aspectFill" />
                  <view wx:else class="text-avatar-small">{{ p.initials }}</view>
                  <view wx:if="{{ idx === 0 }}" class="avatar-badge">ä»˜</view>
                </view>
              </view>
            </view>
            <text class="bill-date">{{ item.date }}</text>
          </view>
        </view>
        <view class="empty-bills" wx:if="{{ recentBills.length === 0 }}">
          <text>æš‚æ— è´¦å•è®°å½•</text>
        </view>
      </view>
    </view>
  </view>
</view>
